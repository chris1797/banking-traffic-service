# 작업 로그 - 2026-01-19

## 작업 요약

이체(Transfer) 기능 구현 완료 - 엔티티, 서비스, 컨트롤러, 테스트, 문서화

---

## 1. Transfer 기능 구현

### 구현 내용

1. **TransferEntity**: 이체 내역 저장용 엔티티
   - `fromAccountNumber`, `toAccountNumber`, `amount`
   - `transferStatus`: PENDING → SUCCESS / FAILED
   - `failureReason`: 실패 사유

2. **TransferService**: 이체 비즈니스 로직
   - 낙관적 락 + 재시도 패턴 적용
   - Deadlock 방지: 계좌번호 정렬하여 일관된 락 순서 유지

3. **TransferController**: REST API
   - POST `/v1/transfer`: 이체 실행
   - GET `/v1/transfer/{id}`: 이체 내역 조회
   - GET `/v1/transfer/account/{accountNumber}`: 계좌별 이체 내역

### 핵심 로직 - Deadlock 방지

```kotlin
// Deadlock 방지: 계좌번호를 정렬하여 일관된 순서로 조회
val sortedAccountNumbers = listOf(request.fromAccountNumber, request.toAccountNumber).sorted()
val firstAccountNumber = sortedAccountNumbers[0]
val secondAccountNumber = sortedAccountNumbers[1]

val firstAccount = accountRepository.findByAccountNumber(firstAccountNumber)
val secondAccount = accountRepository.findByAccountNumber(secondAccountNumber)
```

---

## 변경된 파일

| 파일 | 변경 내용 |
|------|----------|
| `domain/TransferEntity.kt` | 신규 - 이체 엔티티 + TransferStatus enum |
| `repository/TransferRepository.kt` | 신규 - JpaRepository |
| `dto/transfer/request/TransferRequest.kt` | 신규 - 이체 요청 DTO |
| `dto/transfer/response/TransferResponse.kt` | 신규 - 이체 응답 DTO |
| `service/transfer/TransferService.kt` | 신규 - 이체 비즈니스 로직 |
| `api/controller/v1/TransferController.kt` | 신규 - REST API |
| `support/response/error/ErrorCode.kt` | 수정 - ERROR_2001~2004 추가 |
| `support/response/error/ErrorType.kt` | 수정 - Transfer 에러 타입 추가 |
| `service/transfer/unit/TransferServiceTest.kt` | 신규 - 단위 테스트 (12개) |
| `service/transfer/integration/TransferServiceConcurrencyTest.kt` | 신규 - 동시성 테스트 (4개) |
| `docs/transfer/CONCURRENCY.md` | 신규 - 동시성 이슈 문서 |
| `docs/TODO.md` | 수정 - Transfer 섹션 완료 체크 |

---

## 테스트 결과

### 단위 테스트 (12개 모두 통과)
- 이체 성공
- 출금/입금 계좌 없음 → ACCOUNT_NOT_FOUND
- 출금/입금 계좌 삭제됨 → ACCOUNT_DELETED
- 잔액 부족 → INSUFFICIENT_BALANCE
- 동일 계좌 이체 → SAME_ACCOUNT_TRANSFER
- 이체 금액 0 이하 → INVALID_TRANSFER_AMOUNT
- 낙관적 락 재시도 성공/실패
- 이체 내역 조회 성공/실패

### 동시성 테스트 (4개)
- 동시 이체 정합성 테스트
- 여러 계좌 → 한 계좌 이체 테스트
- 잔액 부족 시 일부 성공 테스트
- 교차 이체 Deadlock 방지 테스트

---

## 교훈

1. **Deadlock 방지**: 두 개 이상의 리소스를 동시에 수정할 때는 일관된 순서로 접근해야 함
2. **낙관적 락 재시도**: 충돌 시 자동 재시도하되, 최대 횟수 제한 필요
3. **트랜잭션 설계**: PENDING → SUCCESS/FAILED 상태 전이를 같은 트랜잭션 내에서 처리
