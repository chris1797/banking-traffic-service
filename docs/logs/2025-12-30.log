# 작업 로그 - 2025-12-30

## 작업 요약

Docker Compose 설정 (Redis, K6, InfluxDB, Grafana) 및 K6 부하 테스트 환경 구성

---

## 1. Docker Compose 설정

### 작업 내용
- 로컬 DB 사용으로 PostgreSQL 제외
- Redis (분산 락, 캐시용) 설정
- K6 부하 테스트 인프라 설정 (profile: loadtest)
  - K6: 부하 테스트 실행
  - InfluxDB: 메트릭 저장
  - Grafana: 시각화

### 생성된 파일
```yaml
# compose.yaml
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  k6:
    image: grafana/k6:latest
    profiles: [loadtest]

  influxdb:
    image: influxdb:1.8-alpine
    profiles: [loadtest]

  grafana:
    image: grafana/grafana:latest
    profiles: [loadtest]
```

---

## 2. K6 부하 테스트 환경 구성

### 작업 내용
- K6 테스트 스크립트 디렉토리 구조 생성
- 계좌 생성 부하 테스트 시나리오 작성
- Grafana InfluxDB 데이터소스 프로비저닝 설정
- K6 사용 가이드 문서 작성

### 생성된 파일

| 파일 | 설명 |
|------|------|
| `k6/scenarios/account-create.js` | 계좌 생성 부하 테스트 시나리오 |
| `k6/README.md` | K6 사용 가이드 |
| `k6/results/` | 결과 저장 디렉토리 |
| `grafana/provisioning/datasources/influxdb.yaml` | Grafana 데이터소스 설정 |

### K6 테스트 시나리오
```javascript
// account-create.js
export const options = {
    scenarios: {
        ramp_up: {
            executor: 'ramping-vus',
            stages: [
                { duration: '30s', target: 10 },
                { duration: '1m', target: 10 },
                { duration: '30s', target: 50 },
                { duration: '1m', target: 50 },
                { duration: '30s', target: 0 },
            ],
        },
    },
    thresholds: {
        http_req_duration: ['p(95)<500'],
        http_req_failed: ['rate<0.01'],
    },
};
```

---

## 3. CLAUDE.md 작업 로그 규칙 강화

### 변경 내용
- 모든 작업에 대해 로그 작성 필수 명시
- 반드시 오늘 날짜의 로그 파일에 작성 규칙 추가
- 로그 작성 대상 목록 추가 (코드, 설정, 테스트, 문서 등)

---

## 변경된 파일

| 파일 | 변경 내용 |
|------|----------|
| `compose.yaml` | Redis, K6, InfluxDB, Grafana 설정 |
| `k6/scenarios/account-create.js` | 계좌 생성 부하 테스트 시나리오 |
| `k6/README.md` | K6 사용 가이드 |
| `grafana/provisioning/datasources/influxdb.yaml` | Grafana 데이터소스 설정 |
| `docs/TODO.md` | 완료 항목 체크 |
| `CLAUDE.md` | 작업 로그 규칙 강화 |

---

## 사용 방법

### 기본 실행 (개발)
```bash
docker compose up -d redis
./gradlew bootRun
```

### 부하 테스트 실행
```bash
# 인프라 실행
docker compose --profile loadtest up -d

# K6 테스트 실행
docker compose --profile loadtest run --rm k6 run /scripts/scenarios/account-create.js

# Grafana: http://localhost:3000
```

---

## 4. ARM64 호환성 수정

### 문제점
- Apple Silicon(M1/M2)에서 K6, InfluxDB 이미지 pull 실패
- 에러: `no matching manifest for linux/arm64/v8`

### 해결
- compose.yaml에 `platform: linux/amd64` 추가

```yaml
k6:
  platform: linux/amd64
influxdb:
  platform: linux/amd64
```

---

## 5. Makefile 추가

### 작업 내용
- Docker Compose 명령어 간소화를 위한 Makefile 생성

### 명령어
```makefile
make redis        # Redis 실행
make up           # 부하 테스트 인프라 실행
make down         # 전체 종료
make test-account # Docker K6로 테스트
make test-local   # 로컬 K6로 테스트
```

---

## 6. K6 API 경로 수정

### 문제점
- K6 테스트 100% 실패
- 서버 로그: `No static resource api/v1/accounts`

### 원인
- K6 스크립트 경로: `/api/v1/accounts` (잘못됨)
- 실제 API 경로: `/v1/account`

### 해결
```javascript
// Before
http.post(`${BASE_URL}/api/v1/accounts`, payload, params);

// After
http.post(`${BASE_URL}/v1/account`, payload, params);
```

---

## 변경된 파일 (추가)

| 파일 | 변경 내용 |
|------|----------|
| `compose.yaml` | platform: linux/amd64 추가 |
| `Makefile` | 신규 생성 |
| `k6/scenarios/account-create.js` | API 경로 수정 |

---

## 교훈

1. **Profile 활용**: Docker Compose profile로 개발/테스트 환경 분리
2. **로그 규칙 준수**: 모든 작업은 해당 날짜의 로그 파일에 즉시 기록
3. **ARM64 호환성**: Apple Silicon에서는 `platform: linux/amd64` 명시 필요
4. **API 경로 확인**: 테스트 스크립트 작성 시 실제 Controller 경로 확인 필수