# 작업 로그 - 2025-12-30

## 작업 요약

Docker Compose 설정, K6 부하 테스트 환경 구성, AccountService 계좌 조회 기능 구현

---

## 1. Docker Compose 설정

### 작업 내용
- 로컬 DB 사용으로 PostgreSQL 제외
- Redis (분산 락, 캐시용) 설정
- K6 부하 테스트 인프라 설정 (profile: loadtest)
  - K6: 부하 테스트 실행
  - InfluxDB: 메트릭 저장
  - Grafana: 시각화

---

## 2. K6 부하 테스트 환경 구성

### 작업 내용
- K6 테스트 스크립트 디렉토리 구조 생성
- 계좌 생성 부하 테스트 시나리오 작성
- Grafana InfluxDB 데이터소스 프로비저닝 설정

---

## 3. ARM64 호환성 수정

### 문제점
- Apple Silicon(M1/M2)에서 K6, InfluxDB 이미지 pull 실패
- 에러: `no matching manifest for linux/arm64/v8`

### 해결
```yaml
k6:
  platform: linux/amd64
influxdb:
  platform: linux/amd64
```

---

## 4. Makefile 추가

### 명령어
```makefile
make redis        # Redis 실행
make up           # 부하 테스트 인프라 실행
make down         # 전체 종료
make test-account # Docker K6로 테스트
make test-local   # 로컬 K6로 테스트
```

---

## 5. K6 API 경로 수정

### 문제점
- K6 테스트 100% 실패
- 서버 로그: `No static resource api/v1/accounts`

### 해결
```javascript
// Before
http.post(`${BASE_URL}/api/v1/accounts`, payload, params);

// After
http.post(`${BASE_URL}/v1/account`, payload, params);
```

---

## 6. K6 부하 테스트 결과 분석

### 테스트 결과
| 지표 | 값 | 평가 |
|------|-----|------|
| 총 요청 수 | 44,784 | - |
| 성공률 | 99.96% | 우수 |
| 평균 응답시간 | 6.71ms | 매우 빠름 |
| P95 응답시간 | 19.96ms | 양호 |
| 최대 응답시간 | 233.68ms | 허용 가능 |

### 문제점 1: 결과 파일 저장 실패
**원인**: Docker 컨테이너 내부 경로와 호스트 경로 불일치

```javascript
// Before (호스트 경로)
'./k6/results/account-create-summary.json': JSON.stringify(data)

// After (컨테이너 내부 경로)
'/scripts/results/account-create-summary.json': JSON.stringify(data)
```

### 문제점 2: 실패 원인 확인 불가
**해결**: 실패 시 로그 출력 기능 추가

```javascript
if (!checkResult) {
    console.error(`[FAIL] status=${response.status}, body=${response.body}`);
}
```

### 실패 원인
```
WARN Request Failed error="dial: i/o timeout"
```
- 네트워크 타임아웃으로 인한 연결 실패 (0.04%)

---

## 7. BaseEntity 수정

### 문제점 1: status 필드 접근 불가
```kotlin
// Before
private var status: EntityStatus = EntityStatus.ACTIVE

// After
var status: EntityStatus = EntityStatus.ACTIVE
    protected set  // 외부에서 읽기 가능, 수정은 서브클래스에서만
```

### 문제점 2: isDeleted() 버그
```kotlin
// Before (잘못됨)
fun isDeleted(): Boolean = status == EntityStatus.ACTIVE

// After (수정됨)
fun isDeleted(): Boolean = status == EntityStatus.DELETED
```

---

## 8. AccountRepository 반환 타입 누락 수정

### 문제점
```kotlin
// 반환 타입 없음 → Unit 반환
fun findByAccountNumber(accountNumber: String)
```

### 해결
```kotlin
fun findByAccountNumber(accountNumber: String): Account?
```

---

## 9. AccountService getAccount 구현

### 변경 내용
```kotlin
@Transactional(readOnly = true)
fun getAccount(accountNumber: String): AccountResponse {
    val account = accountRepository.findByAccountNumber(accountNumber)
        ?: throw CoreException(ErrorType.ACCOUNT_NOT_FOUND)

    if (account.isDeleted()) {
        throw CoreException(ErrorType.ACCOUNT_DELETED)
    }

    return AccountResponse.from(account)
}
```

### 설계 결정
- `@Transactional(readOnly = true)`: Hibernate dirty checking 생략, 성능 최적화
- Repository는 단순 조회만 담당 (상태 무관)
- Service에서 비즈니스 검증 수행
- "계좌 없음" vs "삭제된 계좌" 에러 구분 가능

---

## 10. AccountResponse 개선

### 문제점
```kotlin
// 불필요한 nullable과 기본값
data class AccountResponse(
    val id: Long = 0,
    val accountNumber: String? = null,
    ...
)
```

### 해결
```kotlin
data class AccountResponse(
    val id: Long,
    val accountNumber: String,
    ...
) {
    companion object {
        fun from(account: Account): AccountResponse = ...
    }
}
```

---

## 변경된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `compose.yaml` | Redis, K6, InfluxDB, Grafana 설정, platform 추가 |
| `Makefile` | 신규 생성 |
| `k6/scenarios/account-create.js` | 테스트 시나리오, API 경로 수정, 실패 로깅 |
| `k6/README.md` | K6 사용 가이드 |
| `k6/results/` | 디렉토리 생성 |
| `grafana/provisioning/datasources/influxdb.yaml` | Grafana 데이터소스 설정 |
| `CLAUDE.md` | 작업 로그 규칙 강화 |
| `BaseEntity.kt` | status protected set, isDeleted() 버그 수정 |
| `AccountRepository.kt` | findByAccountNumber 반환 타입 추가 |
| `AccountService.kt` | getAccount 구현, @Transactional, isDeleted 검증 |
| `AccountResponse.kt` | nullable 제거, from() 메서드 추가 |

---

## 사용 방법

### 기본 실행 (개발)
```bash
docker compose up -d redis
./gradlew bootRun
```

### 부하 테스트 실행
```bash
docker compose --profile loadtest up -d
make test-account
# Grafana: http://localhost:3000
```

---

## 피드백 및 교훈

### 1. 로그 즉시 기록
- **문제**: 작업 완료 후 로그를 바로 기록하지 않음
- **교훈**: 작업 완료 → 즉시 로그 기록

### 2. DTO 설계
- 엔티티가 non-null이면 DTO도 non-null로 설계
- 의미없는 기본값(`id = 0`) 사용 금지
- `companion object { fun from(entity) }` 패턴 활용

### 3. Kotlin 접근 제한자
- `var field: T protected set` 패턴: 외부 읽기 O, 외부 수정 X

### 4. 코드 리뷰 체크리스트
- [ ] Repository 메서드에 반환 타입 명시했는가?
- [ ] 읽기 전용 메서드에 `@Transactional(readOnly = true)` 추가했는가?
- [ ] Boolean 반환 메서드 로직이 정확한가?
- [ ] DTO 필드가 불필요하게 nullable이 아닌가?

### 5. 설계 원칙
- Repository: 단순 조회 (상태 무관)
- Service: 비즈니스 검증 수행
- 에러 구분: "계좌 없음" vs "삭제된 계좌"