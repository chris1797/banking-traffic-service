# 작업 로그 - 2026-01-06

## 작업 요약

계좌 서비스 코드 리뷰 및 리팩토링

---

## 1. TODO.md 업데이트

### 변경 내용
- 계좌 조회 (getAccount): 완료 표시
- 입금 (deposit): 완료 표시 (낙관적 락 + 재시도 로직 적용)
- 입금 테스트: 완료 표시
- Optimistic Lock 적용: 완료 표시

---

## 2. AccountService 반환 타입 일관성 수정

### 기존 코드
```kotlin
fun createAccount(request: AccountCreateRequest): Account
```

### 문제점
- `getAccount`, `deposit`은 `AccountResponse` 반환
- `createAccount`만 도메인 객체 `Account` 반환
- API 응답 타입 불일치

### 해결
```kotlin
fun createAccount(request: AccountCreateRequest): AccountResponse {
    // ...
    AccountResponse.from(accountRepository.save(accountEntity))
}
```

---

## 3. Account.deposit() 접근 제어 및 검증 추가

### 기존 코드
```kotlin
fun deposit(amount: BigDecimal) {
    this.balance += amount
}
```

### 문제점
- 외부에서 `Account.deposit()` 직접 호출 가능
- 도메인 객체가 자신의 불변식을 보호하지 않음

### 해결
```kotlin
internal fun deposit(amount: BigDecimal) {
    require(amount > BigDecimal.ZERO) { "입금 금액은 0보다 커야 합니다." }
    this.balance += amount
}
```

- `internal`: 같은 모듈 내에서만 접근 가능
- `require`: 잘못된 금액 입력 시 즉시 실패

---

## 4. 테스트 제외 대상 규칙 추가

### 배경
- `getAccount` 테스트 작성 여부 검토
- 단순 조회 로직은 테스트 가성비가 낮음

### 추가된 규칙 (CLAUDE.md)
```markdown
### 테스트 제외 대상
테스트 가성비가 낮은 메서드는 테스트를 생략할 수 있습니다:
- 단순 조회 로직 (Repository 호출 + DTO 변환만 하는 경우)
- 비즈니스 로직 없이 위임만 하는 메서드
```

### 적용
- TODO.md에서 `AccountServiceTest (계좌 조회)` 항목 제거

---

## 변경된 파일

| 파일 | 변경 내용 |
|------|----------|
| `docs/TODO.md` | 계좌 조회, 입금, 테스트 완료 표시 / getAccount 테스트 항목 제거 |
| `AccountService.kt` | createAccount 반환 타입 AccountResponse로 변경 |
| `Account.kt` | deposit 메서드 internal + require 추가 |
| `CLAUDE.md` | 테스트 제외 대상 규칙 추가 |

---

## 미해결 항목 (다음 작업 후보)

| # | 항목 | 우선순위 |
|---|------|----------|
| 1 | 상태 체크 메서드 일관성 (`isDeleted` vs `!isActive`) | 낮음 |
| 2 | 컨트롤러 PathVariable 미사용 | 중간 |
| 3 | 컨트롤러 응답 타입 통일 (`ApiResponse<Any>` → `ApiResponse<AccountResponse>`) | 중간 |
| 4 | 출금 (withdraw) 구현 | - |

---

## 교훈

1. 반환 타입은 레이어별로 일관성 있게 유지해야 유지보수성이 좋아짐
2. 도메인 객체는 자신의 불변식을 스스로 보호해야 함 (방어적 프로그래밍)
3. `internal` 키워드로 접근 범위를 제한하면서도 테스트 가능성 유지 가능
4. 모든 메서드에 테스트가 필요한 것은 아님 - 테스트 가성비를 고려해야 함